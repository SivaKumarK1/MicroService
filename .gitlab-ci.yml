image: docker/compose:latest
services:
  - docker:dind

stages:  
  - maven-compile # Compile
  - test # Test
  - build # Docker compose up step
  - docker-deploy # Docker Hub
  - terraform-job # Terraform 
  - ansible-job # Ansible

# maven-job:
#   image: maven
#   stage: maven-compile
#   script:
#     - sh Jars.sh
#   artifacts:
#     paths:
#       - user_service/target/*.jar
#       - contact_service/target/*.jar

# build-job:    
#   stage: build
#   dependencies:
#     - maven-job
#   script:
#     - echo "Compiling the code..."
#     - docker-compose up --build -d
#     - echo "Compile complete."


# docker-job:
#   stage: docker-deploy
#   dependencies:
#     - maven-job
#   script:
#     - sh Docker_Deploy.sh

# terraform:
#   image: 
#     name: hashicorp/terraform:light
#     entrypoint:
#       - '/usr/bin/env'
#       - 'PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin'
#   before_script:
#   - export AWS_ACCESS_KEY=${AWS_ACCESS_KEY_ID}
#   - export AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
#   - rm -rf .terraform
#   - cd Terraform/Project
#   - terraform --version
#   - terraform init
#   artifacts:
#     paths:
#       - Terraform/Project/inventory/hosts

#   stage: terraform-job 
#   script:
#     - echo "started"
#     - sh make.sh
#     - cat inventory/hosts

  
ansible:
  image: registry.gitlab.com/torese/docker-ansible
  variables:
    ANSIBLE_HOST_KEY_CHECKING: 'false'
    ANSIBLE_FORCE_COLOR: 'true'


  # extends: terraform
  dependencies:
    - terraform
  before_script:
    - export ANSIBLE_HOST_KEY_CHECKING=False
  stage: ansible-job
  script:
    - cd Terraform/Project
    - ansible-playbook -i inventory/hosts playbook.yml
  # when: manual

  
# terraform-destroy:
#   extends: terraform
#   stage: terraform-job
#   script:
#     - pwd
#     - terraform destroy  --auto-approve
#   when: manual
  
